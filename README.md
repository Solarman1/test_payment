# test_payment

# API URL-s главного монолита или gateway

- GET /api/tariffs - получить тарифы
- GET /api/orders - получить orders
- GET /api/orders/{id} - получить order
- POST /api/orders - сохранить order
- POST /api/payment/bill - получить счет на оплату
- POST /api/payment/acquiring - получить ссылку на страницу оплаты

# API URL-s сервиса оплаты
- GET /api/callback - колбэк после оплаты на микросервис оплаты


# сервис заявки или монолит
### Тарифы
Если в админке настраиваются данные, то как указано в таблице, простовляем мин. значения указываем цену за тариф
### Order
- описан в таблице, имеет связь с user и tariff
для проверки статуса подписки пользователя можно запустить воркер, который, каждый день будет проверять
текущий статус по дню окончания последней заявки пользователя. (в запросе смотрим вхождение текущего дня)
За день или два можем отправлять notification на фронт/мейл пользователя/мессенджер сообщение о необходимости обновить подписку.
Если подписка прошла, изменяем expired заявки/подписки и генерим экшн для фронта с уведомлением о том,
что нужно обновить подписку
- можно создать еще таблицу со статусом блокировки/доступа функционала, если expired в order по воркеру проставляем, то из этой дергаем
состояние и блокируем/открываем доступ

# Сервис оплаты
После запроса на апи отправляем в очередь к сервису оплаты данные, смотрим какой тип оплаты нужен
и в зависимости от типа обрабатываем логику: 
1) генерим html/pdf счет, сохрняем его в каком-нибудь сторейдже, отправляем назад ссылку
2) проводим онлайн оплату, по логике сервиса-эквайринга выполняем логику в ответе ссылка на платеж
в обоих случаях отправляем в прослушиваемую очередь необходимые данные и статус платежа

### статусы актуальности оплаты
1) true - ожидание оплаты(счет сгенерирован, ссылка для онлайн оплаты получена)
2) false - отмена оплаты
### статус оплаты
1) 0 - оплаты безупспешна
2) 1 - оплата успешна

### callback
По зачислению средств получаем callback с эквайринг-сервиса или если есть веб-хук с банка-партнера
куда поступают средства при оплате по счету, обрабатываем ответ изменяем статус транзакции.
При ответе о успехе или неудче или отмене: 
1) обновляем данные статуса транзакции, 
2) запускается action и отправляем в прослушиваимаю очередь на main данные

## таблицы сервиса оплаты
### payment_transactions - транзакция оплаты, по эквайрингу или по счету, сохраняем данные при первом запросе, обновляем при изменении статуса( callback или отмена с фронта)
### payment_requests - запрос на оплату, тут храним данные пользователя, данные очереди, тип оплаты